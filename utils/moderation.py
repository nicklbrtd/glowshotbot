"""Ð›Ð¾Ð³Ð¸ÐºÐ° Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð¸ Ð¶Ð°Ð»Ð¾Ð± Ð½Ð° Ñ„Ð¾Ñ‚Ð¾Ð³Ñ€Ð°Ñ„Ð¸Ð¸.

Ð—Ð´ÐµÑÑŒ ÑÐ¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð²ÑÐµ ÐºÐ¾Ð½ÑÑ‚Ð°Ð½Ñ‚Ñ‹ Ð¸ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸, ÑÐ²ÑÐ·Ð°Ð½Ð½Ñ‹Ðµ Ñ Ð¶Ð°Ð»Ð¾Ð±Ð°Ð¼Ð¸ Ð¸ ÑÑ‚Ð°Ñ‚ÑƒÑÐ°Ð¼Ð¸
Ñ„Ð¾Ñ‚Ð¾Ð³Ñ€Ð°Ñ„Ð¸Ð¹, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ñ€Ð°Ð·Ð±Ñ€Ð°ÑÑ‹Ð²Ð°Ñ‚ÑŒ ÑÑ‚Ñƒ Ð»Ð¾Ð³Ð¸ÐºÑƒ Ð¿Ð¾ Ñ€Ð°Ð·Ð½Ñ‹Ð¼ Ñ…ÐµÐ½Ð´Ð»ÐµÑ€Ð°Ð¼.

Ð˜Ð´ÐµÑ:
- ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¼Ð¾Ð¶ÐµÑ‚ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒÑÑ Ð½Ð° Ñ„Ð¾Ñ‚Ð¾, Ð²Ñ‹Ð±Ñ€Ð°Ð² Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ñƒ:
  - ÑÐµÐ»Ñ„Ð¸
  - Ð¿Ð¾Ñ€Ð½Ð¾Ð³Ñ€Ð°Ñ„Ð¸Ñ / 18+
  - Ð¿Ñ€Ð¾Ð¿Ð°Ð³Ð°Ð½Ð´Ð° / Ð½Ð°ÑÐ¸Ð»Ð¸Ðµ
  - Ð´Ñ€ÑƒÐ³Ð¾Ðµ (Ñ Ñ‚ÐµÐºÑÑ‚Ð¾Ð¼)
- ÐšÐ¾Ð³Ð´Ð° Ñ„Ð¾Ñ‚Ð¾ Ð½Ð°Ð±Ð¸Ñ€Ð°ÐµÑ‚ N Ð¶Ð°Ð»Ð¾Ð± (Ð¿Ð¾Ñ€Ð¾Ð³), Ð¾Ð½Ð¾ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑƒÑ…Ð¾Ð´Ð¸Ñ‚ Â«Ð½Ð° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÑƒÂ»:
  - Ñ„Ð¾Ñ‚Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð½Ðµ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð² Ð²Ñ‹Ð´Ð°Ñ‡Ðµ Ð´Ð»Ñ Ð¾Ñ†ÐµÐ½Ð¸Ð²Ð°Ð½Ð¸Ñ;
  - Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ñƒ Ð¿Ñ€Ð¸Ð»ÐµÑ‚Ð°ÐµÑ‚ Ð¿ÑƒÑˆ Ñ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½Ð¾ÑÑ‚ÑÐ¼Ð¸ Ð¸ ÐºÐ½Ð¾Ð¿ÐºÐ°Ð¼Ð¸:
    Â«âœ… Ð’ÑÑ‘ Ñ…Ð¾Ñ€Ð¾ÑˆÐ¾Â» Ð¸ Â«â›” ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÂ».
- ÐŸÑ€Ð¸ Ð½Ð°Ð¶Ð°Ñ‚Ð¸Ð¸ Ð°Ð´Ð¼Ð¸Ð½-ÐºÐ½Ð¾Ð¿Ð¾Ðº Ñ…ÐµÐ½Ð´Ð»ÐµÑ€ Ð´Ð¾Ð»Ð¶ÐµÐ½:
  - Ð¿Ð¾Ð¼ÐµÑ‚Ð¸Ñ‚ÑŒ Ð¶Ð°Ð»Ð¾Ð±Ñ‹ ÐºÐ°Ðº Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ðµ (Ð¾Ðº / Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¾);
  - ÐµÑÐ»Ð¸ Ñ„Ð¾Ñ‚Ð¾ Â«Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾Â» â€” Ð±Ð¾Ð»ÑŒÑˆÐµ Ð½Ðµ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ ÐµÐ³Ð¾ Ð² Ð¾Ñ†ÐµÐ½ÐºÐµ;
  - Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾ Ð·Ð°Ð±Ð°Ð½Ð¸Ñ‚ÑŒ Ð°Ð²Ñ‚Ð¾Ñ€Ñƒ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ Ð½Ð¾Ð²Ñ‹Ñ… Ñ€Ð°Ð±Ð¾Ñ‚ Ð½Ð° ÑÑƒÑ‚ÐºÐ¸.

Ð­Ñ‚Ð¾Ñ‚ Ð¼Ð¾Ð´ÑƒÐ»ÑŒ ÐÐ• Ð¿Ñ€Ð¸Ð²ÑÐ·Ð°Ð½ Ðº aiogram. ÐžÐ½ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð±Ð¸Ð·Ð½ÐµÑ-Ð»Ð¾Ð³Ð¸ÐºÑƒ Ð¸
ÐºÐ¾Ð½ÑÑ‚Ð°Ð½Ñ‚Ñ‹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð¼Ð¾Ð¶Ð½Ð¾ Ð²Ñ‹Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ Ð¸Ð· Ñ…ÐµÐ½Ð´Ð»ÐµÑ€Ð¾Ð² (`handlers/rate.py`,
`handlers/admin.py` Ð¸ Ñ‚.Ð´.).
"""

from __future__ import annotations

from dataclasses import dataclass
from datetime import datetime, timedelta
from typing import Final, Literal, Sequence


# ---- ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ñ‹ Ð¶Ð°Ð»Ð¾Ð± ----

ReportReason = Literal[
    "selfie",          # ÑÐµÐ»Ñ„Ð¸ / Ð¿Ð¾Ñ€Ñ‚Ñ€ÐµÑ‚ Ð°Ð²Ñ‚Ð¾Ñ€Ð°
    "porn",            # Ð¿Ð¾Ñ€Ð½Ð¾Ð³Ñ€Ð°Ñ„Ð¸Ñ / 18+
    "stolen",          # Ñ‡ÑƒÐ¶Ð¾Ðµ Ñ„Ð¾Ñ‚Ð¾ / Ð²Ð¾Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚
    "propaganda",      # Ð¿Ñ€Ð¾Ð¿Ð°Ð³Ð°Ð½Ð´Ð°
    "violence",        # ÑÑ†ÐµÐ½Ñ‹ Ð½Ð°ÑÐ¸Ð»Ð¸Ñ
    "hate",            # Ñ€Ð°Ð·Ð¶Ð¸Ð³Ð°Ð½Ð¸Ðµ Ð½ÐµÐ½Ð°Ð²Ð¸ÑÑ‚Ð¸
    "illegal_ads",     # Ð½ÐµÐ·Ð°ÐºÐ¾Ð½Ð½Ð°Ñ Ñ€ÐµÐºÐ»Ð°Ð¼Ð° / Ð·Ð°Ð¿Ñ€ÐµÑ‰Ñ‘Ð½Ð½Ñ‹Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹ Ð¸ ÑƒÑÐ»ÑƒÐ³Ð¸
    "other",           # Ð´Ñ€ÑƒÐ³Ð¾Ðµ
]

REPORT_REASON_LABELS: Final[dict[ReportReason, str]] = {
    "selfie": "ðŸ¤³ Ð¡ÐµÐ»Ñ„Ð¸ / Ð¿Ð¾Ñ€Ñ‚Ñ€ÐµÑ‚ Ð°Ð²Ñ‚Ð¾Ñ€Ð°",
    "porn": "ðŸ”ž ÐŸÐ¾Ñ€Ð½Ð¾Ð³Ñ€Ð°Ñ„Ð¸Ñ / 18+ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚",
    "stolen": "ðŸ–¼ï¸ Ð§ÑƒÐ¶Ð°Ñ Ñ„Ð¾Ñ‚Ð¾Ð³Ñ€Ð°Ñ„Ð¸Ñ / Ð²Ð¾Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚",
    "propaganda": "ðŸ“¢ ÐŸÑ€Ð¾Ð¿Ð°Ð³Ð°Ð½Ð´Ð°",
    "violence": "ðŸ’£ ÐÐ°ÑÐ¸Ð»Ð¸Ðµ / Ð¶Ñ‘ÑÑ‚ÐºÐ¸Ðµ ÑÑ†ÐµÐ½Ñ‹",
    "hate": "ðŸ”¥ Ð Ð°Ð·Ð¶Ð¸Ð³Ð°Ð½Ð¸Ðµ Ð½ÐµÐ½Ð°Ð²Ð¸ÑÑ‚Ð¸",
    "illegal_ads": "ðŸš« ÐÐµÐ·Ð°ÐºÐ¾Ð½Ð½Ð°Ñ Ñ€ÐµÐºÐ»Ð°Ð¼Ð°",
    "other": "ðŸ“ Ð”Ñ€ÑƒÐ³Ð¾Ðµ (Ð¾Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð² Ñ‚ÐµÐºÑÑ‚Ðµ)",
}


def get_report_reasons() -> Sequence[ReportReason]:
    return (
        "selfie",
        "porn",
        "stolen",
        "propaganda",
        "violence",
        "hate",
        "illegal_ads",
        "other",
    )


# ---- ÐŸÐ¾Ñ€Ð¾Ð³ Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸Ð¸ ----

REPORT_THRESHOLD: Final[int] = 3


@dataclass(slots=True)
class ReportStats:
    photo_id: int
    total_pending: int      
    total_all: int


@dataclass(slots=True)
class ModerationDecision:
    should_mark_under_review: bool 
    reached_threshold: bool       

def decide_after_new_report(stats: ReportStats) -> ModerationDecision:
    reached = stats.total_pending >= REPORT_THRESHOLD
    return ModerationDecision(
        should_mark_under_review=reached,
        reached_threshold=reached,
    )


# ---- Ð‘Ð°Ð½Ñ‹ Ð½Ð° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ Ð½Ð¾Ð²Ñ‹Ñ… Ñ€Ð°Ð±Ð¾Ñ‚ ----

@dataclass(slots=True)
class UploadBan:

    user_id: int
    banned_until: datetime

    @property
    def is_active(self) -> bool:
        return datetime.utcnow() < self.banned_until


def get_one_day_ban_until(now: datetime | None = None) -> datetime:
    if now is None:
        now = datetime.utcnow()
    return now + timedelta(days=1)


__all__ = [
    "ReportReason",
    "REPORT_REASON_LABELS",
    "get_report_reasons",
    "REPORT_THRESHOLD",
    "ReportStats",
    "ModerationDecision",
    "decide_after_new_report",
    "UploadBan",
    "get_one_day_ban_until",
]