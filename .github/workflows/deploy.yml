name: Deploy GlowShot

on:
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Deploy on VDS
        shell: bash
        run: |
          set -euo pipefail

          echo "‚û°Ô∏è –ü–µ—Ä–µ—Ö–æ–∂—É –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞..."
          cd /home/nick/glowshotbot

          echo "‚û°Ô∏è –û–±–Ω–æ–≤–ª—è—é —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
          git fetch --all
          git reset --hard origin/main

          echo "‚û°Ô∏è –ê–∫—Ç–∏–≤–∏—Ä—É—é venv –∏ —Å—Ç–∞–≤–ª—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
          /home/nick/glowshotbot/venv/bin/python -m pip install --upgrade pip
          /home/nick/glowshotbot/venv/bin/pip install -r requirements.txt

          echo "‚û°Ô∏è –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–∏—Å—ã..."
          sudo systemctl restart glowshot-bot
          sudo systemctl restart glowshot-support
          sudo systemctl restart tbank-webhook

          echo "‚û°Ô∏è –ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç–∞—Ç—É—Å..."
          sudo systemctl --no-pager --full status glowshot-bot || true
          sudo systemctl --no-pager --full status glowshot-support || true
          sudo systemctl --no-pager --full status tbank-webhook || true

          echo "üéâ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω!"
