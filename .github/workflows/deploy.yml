name: Deploy GlowShot

on:
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Deploy on VDS
        shell: bash
        run: |
          set -euo pipefail

          echo "‚û°Ô∏è –ü–µ—Ä–µ—Ö–æ–∂—É –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞..."
          cd /home/nick/glowshotbot

          echo "‚û°Ô∏è –û–±–Ω–æ–≤–ª—è—é —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
          git fetch --all
          git reset --hard origin/main

          echo "‚û°Ô∏è –ê–∫—Ç–∏–≤–∏—Ä—É—é venv –∏ —Å—Ç–∞–≤–ª—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
          /home/nick/glowshotbot/venv/bin/python -m pip install --upgrade pip
          /home/nick/glowshotbot/venv/bin/pip install -r requirements.txt

          # –í–∞–∂–Ω–æ: runner —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ TTY, –ø–æ—ç—Ç–æ–º—É sudo –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–µ–∑ –ø–∞—Ä–æ–ª—è.
          # `-n` –∑–∞—Å—Ç–∞–≤–∏—Ç sudo –ù–ï —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å –∏ —É–ø–∞—Å—Ç—å —Å—Ä–∞–∑—É, –µ—Å–ª–∏ –ø—Ä–∞–≤ –Ω–µ—Ç.
          echo "‚û°Ô∏è –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å—Ç–∞—Ä—ã–µ –∏–Ω—Å—Ç–∞–Ω—Å—ã (–Ω–∞ –≤—Å—è–∫–∏–π)..."
          # –ï—Å–ª–∏ –∫–æ–≥–¥–∞-—Ç–æ –±—ã–ª —Å—Ç–∞—Ä—ã–π —Å–µ—Ä–≤–∏—Å glowshot ‚Äî —Å—Ç–æ–ø–∞–µ–º –µ–≥–æ, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ double polling.
          sudo -n /bin/systemctl stop glowshot.service || true
          sudo -n /bin/systemctl disable glowshot.service || true

          # –£–±–∏–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ —Ä—É—á–Ω—ã–µ –∑–∞–ø—É—Å–∫–∏ (screen/tmux/nohup –∏ —Ç.–ø.).
          # –≠—Ç–æ –Ω–µ —Ç—Ä–æ–Ω–µ—Ç glowshot-support, —Ç.–∫. —É –Ω–µ–≥–æ –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª.
          sudo -n /usr/bin/pkill -f "/home/nick/glowshotbot/bot.py" || true

          echo "‚û°Ô∏è –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–∏—Å—ã..."
          sudo -n /bin/systemctl restart glowshot-bot
          sudo -n /bin/systemctl restart glowshot-support
          sudo -n /bin/systemctl restart tbank-webhook

          echo "‚û°Ô∏è –ü—Ä–æ–≤–µ—Ä—è—é, —á—Ç–æ –∑–∞–ø—É—â–µ–Ω —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω bot.py..."
          sudo -n /bin/ps aux | /bin/grep -E "/home/nick/glowshotbot/(bot\\.py|support_bot\\.py)" | /bin/grep -v grep || true

          echo "üéâ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω!"
