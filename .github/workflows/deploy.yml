name: Deploy GlowShot

on:
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Deploy on VDS
        shell: bash
        run: |
          set -euo pipefail

          echo "‚û°Ô∏è –ü–µ—Ä–µ—Ö–æ–∂—É –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞..."
          cd /home/nick/glowshotbot

          echo "‚û°Ô∏è –û–±–Ω–æ–≤–ª—è—é —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
          git fetch --all
          git reset --hard origin/main

          echo "‚û°Ô∏è –ê–∫—Ç–∏–≤–∏—Ä—É—é venv –∏ —Å—Ç–∞–≤–ª—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
          /home/nick/glowshotbot/venv/bin/python -m pip install --upgrade pip
          /home/nick/glowshotbot/venv/bin/pip install -r requirements.txt

          # –í–∞–∂–Ω–æ: runner —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ TTY, –ø–æ—ç—Ç–æ–º—É sudo –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–µ–∑ –ø–∞—Ä–æ–ª—è.
          # `-n` –∑–∞—Å—Ç–∞–≤–∏—Ç sudo –ù–ï —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å –∏ —É–ø–∞—Å—Ç—å —Å—Ä–∞–∑—É, –µ—Å–ª–∏ –ø—Ä–∞–≤ –Ω–µ—Ç.
          echo "‚û°Ô∏è –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–∏—Å—ã..."
          sudo -n /bin/systemctl restart glowshot-bot
          sudo -n /bin/systemctl restart glowshot-support
          sudo -n /bin/systemctl restart tbank-webhook

          echo "‚û°Ô∏è –ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç–∞—Ç—É—Å..."
          sudo -n /bin/systemctl --no-pager --full status glowshot-bot || true
          sudo -n /bin/systemctl --no-pager --full status glowshot-support || true
          sudo -n /bin/systemctl --no-pager --full status tbank-webhook || true

          echo "üéâ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω!"
