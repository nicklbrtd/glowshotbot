name: Deploy GlowShot

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "‚û°Ô∏è –ü–µ—Ä–µ—Ö–æ–∂—É –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞..."
            cd /home/nick/glowshotbot

            echo "‚û°Ô∏è –û–±–Ω–æ–≤–ª—è—é —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
            git fetch --all
            git reset --hard origin/main

            echo "‚û°Ô∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
            /home/nick/glowshotbot/venv/bin/pip install -r requirements.txt

            echo "‚û°Ô∏è –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–∏—Å—ã..."
            sudo systemctl restart glowshot-bot
            sudo systemctl restart glowshot-support
            sudo systemctl restart tbank-webhook

            echo "‚û°Ô∏è –ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç–∞—Ç—É—Å..."
            sudo systemctl status glowshot-bot --no-pager || true
            sudo systemctl status glowshot-support --no-pager || true
            sudo systemctl status tbank-webhook --no-pager || true

            echo "üéâ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω!"
